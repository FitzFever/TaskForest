<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>极简模型查看器</title>
  <style>
    body { margin: 0; overflow: hidden; }
    #status { 
      position: absolute; 
      top: 10px; 
      left: 10px; 
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      font-family: monospace;
    }
    .model-link {
      display: block;
      margin: 5px 0;
      color: #4CAF50;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="status">加载中...</div>
  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.module.js';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.153.0/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.153.0/examples/jsm/loaders/GLTFLoader.js';

    // 初始化状态显示
    const status = document.getElementById('status');
    
    // 创建场景和相机
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x333333);
    
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(5, 5, 5);
    
    // 创建渲染器
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    
    // 添加控制器
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.target.set(0, 0, 0);
    controls.update();
    
    // 添加灯光
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
    directionalLight.position.set(5, 5, 5);
    scene.add(directionalLight);
    
    // 添加网格辅助
    const gridHelper = new THREE.GridHelper(10, 10);
    scene.add(gridHelper);
    
    // 当前加载的模型
    let currentModel = null;
    
    // 加载模型函数
    function loadModel(url) {
      // 移除之前的模型
      if (currentModel) {
        scene.remove(currentModel);
      }
      
      // 更新状态
      status.innerHTML = `加载模型中: ${url}`;
      console.log(`尝试加载模型: ${url}`);
      
      const loader = new GLTFLoader();
      
      // 记录开始时间
      const startTime = performance.now();
      
      loader.load(
        url,
        function(gltf) {
          const model = gltf.scene;
          
          // 计算加载时间
          const loadTime = ((performance.now() - startTime) / 1000).toFixed(2);
          
          // 获取模型信息
          let vertexCount = 0;
          let triangleCount = 0;
          
          model.traverse((node) => {
            if (node.isMesh && node.geometry) {
              vertexCount += node.geometry.attributes.position.count;
              if (node.geometry.index) {
                triangleCount += node.geometry.index.count / 3;
              } else {
                triangleCount += node.geometry.attributes.position.count / 3;
              }
            }
          });
          
          // 计算包围盒并居中模型
          const box = new THREE.Box3().setFromObject(model);
          const size = box.getSize(new THREE.Vector3());
          const center = box.getCenter(new THREE.Vector3());
          
          model.position.x = -center.x;
          model.position.y = -center.y;
          model.position.z = -center.z;
          
          scene.add(model);
          currentModel = model;
          
          status.innerHTML = `
            <div>模型加载成功! (${loadTime}秒)</div>
            <div>文件: ${url.split('/').pop()}</div>
            <div>顶点数: ${vertexCount.toLocaleString()}</div>
            <div>面数: ${Math.round(triangleCount).toLocaleString()}</div>
            <div>尺寸: ${size.x.toFixed(2)} x ${size.y.toFixed(2)} x ${size.z.toFixed(2)}</div>
          `;
          
          console.log(`模型加载成功: ${url}`);
        },
        function(xhr) {
          const percent = Math.floor((xhr.loaded / xhr.total) * 100);
          status.innerHTML = `加载进度: ${percent}% - ${url}`;
        },
        function(error) {
          status.innerHTML = `加载失败: ${error.message}`;
          console.error(`模型加载失败: ${url}`, error);
        }
      );
    }
    
    // 获取并显示模型列表
    fetch('/listExport')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          let html = `
            <div>可用模型(${data.files.length}):</div>
          `;
          
          data.paths.forEach(path => {
            html += `<div class="model-link" onclick="window.loadModel('${path}')">${path.split('/').pop()}</div>`;
          });
          
          status.innerHTML = html;
          
          // 加载第一个模型
          if (data.paths.length > 0) {
            setTimeout(() => loadModel(data.paths[0]), 1000);
          }
        } else {
          status.innerHTML = `获取模型列表失败: ${data.error}`;
        }
      })
      .catch(error => {
        status.innerHTML = `获取模型列表错误: ${error.message}`;
        console.error('获取模型列表错误:', error);
      });
    
    // 将loadModel函数暴露给全局作用域
    window.loadModel = loadModel;
    
    // 窗口大小调整
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
    
    // 渲染循环
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    
    animate();
  </script>
</body>
</html> 