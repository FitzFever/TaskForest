<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>直接测试 - 最简单3D模型加载</title>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; }
    canvas { display: block; }
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      font-family: monospace;
    }
    #model-selector {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      border-radius: 4px;
      z-index: 100;
    }
    select {
      margin-top: 5px;
      padding: 5px;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="status">加载中...</div>
  <div id="model-selector">
    <div>选择模型:</div>
    <select id="model-dropdown" onchange="loadSelectedModel()">
      <option value="">-- 选择模型 --</option>
      <option value="export/trees/oak.glb">橡树 (Oak)</option>
      <option value="export/trees/pine.glb">松树 (Pine)</option>
      <option value="export/trees/maple.glb">枫树 (Maple)</option>
      <option value="export/trees/cherry.glb">樱花树 (Cherry)</option>
      <option value="export/trees/apple.glb">苹果树 (Apple)</option>
      <option value="export/trees/palm.glb">棕榈树 (Palm)</option>
      <option value="export/trees/willow.glb">柳树 (Willow)</option>
      <option value="export/trees/healthy_tree.glb">健康树</option>
      <option value="export/trees/slightly_wilted_tree.glb">轻微枯萎树</option>
      <option value="export/trees/moderately_wilted_tree.glb">中度枯萎树</option>
      <option value="export/trees/severely_wilted_tree.glb">严重枯萎树</option>
    </select>
  </div>

  <!-- 加载Three.js库 - 旧版本 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/110/three.min.js"></script>
  
  <!-- 接下来引入GLTFLoader -->
  <script>
    // 手动加载GLTFLoader
    document.write('<script src="https://cdn.jsdelivr.net/npm/three@0.110.0/examples/js/loaders/GLTFLoader.js"><\/script>');
  </script>

  <script>
    let container, camera, scene, renderer, model;
    const status = document.getElementById('status');
    
    // 显示日志
    function log(text) {
      console.log(text);
      status.textContent = text;
    }

    // 初始化场景
    function init() {
      // 创建场景
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x333333);
      
      // 创建相机
      camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
      camera.position.set(0, 5, 10);
      
      // 创建渲染器
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);
      
      // 添加灯光
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(1, 1, 1);
      scene.add(directionalLight);
      
      // 添加网格
      const gridHelper = new THREE.GridHelper(10, 10);
      scene.add(gridHelper);
      
      // 窗口大小调整
      window.addEventListener('resize', onWindowResize, false);
      
      log("场景已初始化，正在检查URL参数...");
      
      // 检查GLTFLoader是否可用
      if (typeof THREE.GLTFLoader === 'undefined') {
        log("错误: GLTFLoader未加载");
        return;
      }
      
      // 检查URL参数中是否有模型路径
      const urlParams = new URLSearchParams(window.location.search);
      const modelParam = urlParams.get('model');
      
      if (modelParam) {
        // 从URL参数加载模型
        loadModel(modelParam);
        // 更新下拉框选择
        const dropdown = document.getElementById('model-dropdown');
        for(let i = 0; i < dropdown.options.length; i++) {
          if(dropdown.options[i].value === modelParam) {
            dropdown.selectedIndex = i;
            break;
          }
        }
      } else {
        // 默认加载橡树模型
        log("未指定模型，请从下拉菜单选择一个模型");
      }
    }
    
    // 从下拉框加载选中的模型
    function loadSelectedModel() {
      const dropdown = document.getElementById('model-dropdown');
      const selectedValue = dropdown.value;
      if (selectedValue) {
        loadModel(selectedValue);
        // 更新URL参数但不刷新页面
        const url = new URL(window.location);
        url.searchParams.set('model', selectedValue);
        window.history.pushState({}, '', url);
      }
    }
    
    // 加载模型
    function loadModel(path) {
      log(`开始加载模型: ${path}`);
      
      // 移除已有模型
      if (model) {
        log(`移除之前的模型`);
        scene.remove(model);
      }
      
      // 确认模型路径
      log(`模型完整路径: ${window.location.origin}/${path}`);
      
      // 使用Three.js的GLTFLoader加载模型
      const loader = new THREE.GLTFLoader();
      log(`GLTFLoader创建成功，开始加载...`);
      
      loader.load(
        path,
        function(gltf) {
          // 加载成功
          log(`模型加载成功，处理模型场景...`);
          model = gltf.scene;
          
          // 打印模型信息
          log(`模型内容: ${model ? '找到模型' : '模型为空'}`);
          log(`模型子对象数: ${model.children.length}`);
          
          // 打印模型内容
          if (model.children.length > 0) {
            log(`包含以下子对象:`);
            model.children.forEach((child, index) => {
              log(`  ${index+1}. ${child.name} (类型: ${child.type})`);
            });
          }
          
          // 调整模型大小和位置
          const box = new THREE.Box3().setFromObject(model);
          const size = box.getSize(new THREE.Vector3());
          const center = box.getCenter(new THREE.Vector3());
          
          log(`模型尺寸: ${size.x.toFixed(2)} x ${size.y.toFixed(2)} x ${size.z.toFixed(2)}`);
          log(`模型中心: ${center.x.toFixed(2)}, ${center.y.toFixed(2)}, ${center.z.toFixed(2)}`);
          
          model.position.x = -center.x;
          model.position.y = -center.y;
          model.position.z = -center.z;
          
          scene.add(model);
          
          log(`模型加载并添加到场景成功! 请检查是否显示正确`);
          
          // 调整相机视角
          const maxDim = Math.max(size.x, size.y, size.z);
          const distance = maxDim * 2.5;
          camera.position.set(distance, distance / 2, distance);
          camera.lookAt(new THREE.Vector3(0, 0, 0));
        },
        function(xhr) {
          if (xhr.total > 0) {
            const percent = Math.floor((xhr.loaded / xhr.total) * 100);
            log(`加载进度: ${percent}% (${xhr.loaded} / ${xhr.total}字节)`);
          } else {
            log(`加载进度: ${xhr.loaded} 字节`);
          }
        },
        function(error) {
          log(`加载错误: ${error.message}`);
          log(`请检查模型文件是否存在，路径是否正确`);
          console.error("详细错误信息:", error);
        }
      );
    }
    
    // 调整窗口大小
    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }
    
    // 动画循环
    function animate() {
      requestAnimationFrame(animate);
      
      // 旋转模型(如果存在)
      if (model) {
        model.rotation.y += 0.005;
      }
      
      renderer.render(scene, camera);
    }
    
    // 启动应用
    init();
    animate();
  </script>
</body>
</html> 